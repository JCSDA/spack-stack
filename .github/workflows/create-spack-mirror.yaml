name: create-spack-mirror

on:
  workflow_dispatch:
    inputs:
      app:
        type: string
        description: "App to generate mirror for"
        required: true
        default: "all"
      site:
        type: string
        description: "Site to create environment for"
        required: true
        default: "default"
jobs:
  create-spack-mirror:
    runs-on: ubuntu-latest

    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          submodules: true

      - name: create-env
        run: |
          source ./setup.sh
          ./create-env.py --app ${{ github.event.inputs.app }}  --site ${{ github.event.inputs.site }}  --name all
          spack env activate -d envs/all
          spack compiler find
          spack add re2c
          spack add clingo
          spack concretize
          spack mirror create -a
          # upload-artifact does not allow filenames that begin with '?'
          rm cache/source_cache/autoconf/\?id=05972f49ee632cd98057a3caf82ebfb9574846da-eaa3f69
          rm cache/source_cache/boost/attachment.cgi?id=356970-b6f6ce6
          rm cache/source_cache/py-scipy/extern_decls.patch?id=711fe05025795e44b84233e065d240859ccae5bd-5433f60

      - name: upload-mirror
        uses: actions/upload-artifact@v2
        with:
          name: spack_mirror
          path: cache/source_cache
